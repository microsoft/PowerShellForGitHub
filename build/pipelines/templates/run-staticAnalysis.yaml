#
# This template contains the necessary jobs to run PSScriptAnalyzer on the repo and
# report the results.
#

steps:
  - powershell: |
      Install-Module -Name PSScriptAnalyzer -Repository PSGallery -Scope CurrentUser -AllowClobber -SkipPublisherCheck -Force -Verbose
    displayName: 'Install PSScriptAnalyzer'

  - powershell: |
       $results = Invoke-ScriptAnalyzer -Path ./ â€“Recurse
      ./build/scripts/ConvertTo-NUnitXml.ps1 -ScriptAnalyzerResult $results -OutPath ../Pester/scriptAnalyzer-results.xml
    displayName: 'Run Static Code Analysis (PSScriptAnalyzer)'

  - task: PublishTestResults@2
    displayName: 'Publish ScriptAnalyzer Test Results'
    inputs:
      testRunTitle: 'Windows Test Results for PSScriptAnalyzer'
      buildPlatform: 'Windows'
      testRunner: NUnit
      testResultsFiles: '../Pester/scriptAnalyzer-results.xml'
      failTaskOnFailedTests: true # required to fail build when tests fail
    condition: succeededOrFailed()
